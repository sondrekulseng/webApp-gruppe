<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Bestill</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        body {
            margin: auto;
            width: 60%;
            margin-top: 1em;
            background-image: url('http://cdn.cnn.com/cnnnext/dam/assets/210504130820-msc-magnifica.jpg');
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: cover;
        }

        .form-control {
            margin-bottom: 0.5em;
        }

        .hovedboks {
            background-color: #000;
            margin: auto;
            padding: 1.5em;
            opacity: 0.9;
            color: white;
            width: 60%;
        }

        table {
            margin-top: 1em;
        }

        #divRetur {
            display: none;
        }
    </style>
</head>
<body onload="hentBestillinger()">
    <h1 style="text-align: center; color: white;">EasyCruise</h1>
  
    <form class="form-group hovedboks" id="frmBestill">
        <h3>Bestill reise</h3>
        <!-- Velg reise-->
        <input type="radio" name="tur" id="enVei" value=0 onclick="endreSkjema(this.value)" checked />
        <label for="enVei">En Vei</label>
        <input type="radio" name="tur" id="retur" value=1 onclick="endreSkjema(this.value)" />
        <label for="retur">Tur/Retur</label>
        <!-- Velg strekning -->
        <h4>Velg strekning</h4>
        <select id="velgStrekning" class="form-control"></select>
        <!-- Velg avreisedato -->
        <h4>Avreise</h4>
        <input type="date" class="form-control" id="velgReturDato" onchange="validateRetur(this.value)" required />
        <!-- Hjemreise dato -->
        <h4>Retur</h4>
        <input type="date" class="form-control" id="velgDato" onchange="validateRetur(this.value)" required />
        <!-- Kundeinfo -->
        <h4>Kunde info</h4>
        <input type="text" class="form-control" id="inpFornavn" placeholder="Fornavn" required />
        <input type="text" class="form-control" id="inpEtternavn" placeholder="Etternavn" required />
        <input type="email" class="form-control" id="inpEpost" placeholder="Epost" required />
        <input type="tel" class="form-control" id="inpTelefon" placeholder="Telefon" required />
        <div class="alert alert-info" id="frmMsg" style="display: none;"></div>
        <button type="submit" class="btn btn-primary">Send bestilling</button>
    </form>
    <table id="tabell" class="table table-bordered table table-hover"  style="background-color:white;border-width:10px;">
        <tr>
            <th>Fornavn</th>
            <th>Etternavn</th>
            <th>E-post</th>
            <th>Telefon</th>
            <th>Strekning</th>
            <th>Avreise</th>
            <th>Retur</th>
            <th>Total pris</th>
        </tr>
    </table>
    <script>
        function endreSkjema(val) {
            if (val == 0) {
                // en vei
                $("#divRetur").css("display", "none");
            } else {
                $("#divRetur").css("display", "block");
            }
        }

        function validateRetur(avreiseDato) {
            $("#velgReturDato").attr("min", avreiseDato);
            $("#velgReturDato").prop("disabled", false);
        }

        function currentDate() {
            var today = new Date();
            var dd = String(today.getDate()).padStart(2, '0');
            var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
            var yyyy = today.getFullYear();

            today = yyyy + '-' + mm + '-' + dd;

            return today;
        }

        $("#velgDato").attr("min", currentDate());

        $.get("Strekning/hent", function (data) {
            console.log(data);
            for (let i = 0; i < data.length; i++) {
                $("#velgStrekning").append(`<option>${data[i].strekning}, ${data[i].pris} kr</option>`);
            }
        });
        
        function hentBestillinger() {

            $.get("Bestilling/hentAlle", function (data) {
                console.log(data);
                for (var i = 0; i < data.length; i++) {
                    let returDato = "Ingen retur";
                    let totalPris = data[i].pris;
                    if (data[i].formatRetur != "01.01.0001") {
                        returDato = data[i].formatRetur;
                        totalPris = totalPris * 2;
                    }
                    $("#tabell").append(`<tr>
                                            <td>${data[i].fornavn}</td>
                                            <td>${data[i].etternavn}</td>
                                            <td>${data[i].epost}</td>
                                            <td>${data[i].telefon}</td>
                                            <td>${data[i].strekning}, ${data[i].pris} kr</td>
                                            <td>${data[i].formatAvreise}</td>
                                            <td>${returDato}</td>
                                            <td>${totalPris} kr</td>
                                        </tr>`);
                }
            });
        }

        document.getElementById("frmBestill").onsubmit = function (evt) {
            evt.preventDefault();

            const bestilling = {
                fornavn: $("#inpFornavn").val(),
                etternavn: $("#inpEtternavn").val(),
                epost: $("#inpEpost").val(),
                telefon: $("#inpTelefon").val(),
                avreiseDato: $("#velgDato").val(),
                returDato: $("#velgReturDato").val(),
                strekningID: document.getElementById("velgStrekning").selectedIndex
            };

            $.post("Bestilling/lagre", bestilling, function () {
                $("#inpFornavn").val("");
                $("#inpEtternavn").val("");
                $("#inpEpost").val("");
                $("#inpTelefon").val("");
                $("#velgDato").val("");
                $("#velgReturDato").val("");
                $("#frmMsg").css("display", "block");
                $("#frmMsg").html("Bestilling lagret");
                hentBestillinger();
            });
        }</script>
</body>
</html>